---
title: "Proyecto en Grupo"
author: "Natalia Fitipaldi, Matías Muñoz, Pedro Milat, Mateo Pérez"
date: "Julio 2021"
output:
  pdf_document:
    latex_engine: xelatex
  fig_caption: true
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy.opts = list(width.cutoff = 50), tidy = TRUE, fig.pos = 'h', out.extra = '', message = FALSE, warning = FALSE)
```


## Introducción

El presente documento contiene el resultado del trabajo final de Nuevas Tecnologías 
para el Análisis Estadístico de Datos cuyo objetivo es utilizar adecuadamente las 
herramientas computacionales aprendidas en clase para realizar el análisis exploratorio
de unos datos de interés. Estos datos fueron seleccionados, por los integrantes del
grupo, del portal geográfico de la UNASEV, son datos referentes a personas involucradas
en accidentes de tránsito entre los años 2013 a 2021.
El análisis tendrá por objetivo obtener una descripción en términos estadísticos sobre 
los datos bajo estudio, así como plantear y responder preguntas de interés que formarán 
parte del problema a resolver, este estudio se hará mediante la elaboración de gráficos 
y resúmenes sobre las variables relevantes que componen la base de información así 
como también el planteo de una aplicación web en shiny.

Un accidente de tránsito es un suceso imprevisto que implica una colisión o algún tipo de impacto de al menos un vehículo en movimiento en la vía pública, y que genera consecuencias ya sean materiales o físicas. Es un suceso evitable. Lamentablemente es un evento que ocurre diariamente, en todos los países y que involucra a toda la población, por lo que nos pareció interesante para tomarlo como objeto de estudio. 
La primer pregunta que nos surgió cuando pensamos en accidentes de tránsito fue, 
¿Qué tan graves o leves fueron estos accidentes? para ver si hay muchos accidentes 
en los que se llego al fallecimiento de alguna persona, o en general son heridas leves,
Esto va a depender de distintos factores, entre los cuáles consideramos de mayor relevancia el vehículo en el cual se encontraba el accidentado, 
este puede ser auto, bicicleta o moto, entre otros.
Otra pregunta que nos planteamos, es si la cantidad de 
accidentes de tránsito podría estar ligada a los cambios en el tiempo. Ya que los datos
contienen información desde 2013 hasta 2021 realizamos una serie temporal para ver
si en el correr de los años hubo una tendencia a bajar la cantidad de accidentes, 
o si por el contrario hoy en día hay más accidentes que hace unos años.
Por otro lado, consideramos realizar un análisis por departamento, ¿cuáles fueron los 
departamentos que han sufrido mayores accidentes de tránsito, y cuáles fueron los que
han sufrido menos?. Es evidente que se tendría que tener en cuenta el tema de la población,
por lo que estaría bueno comparar la cantidad de accidentes cada 1000 habitantes por ejemplo.
Luego consideramos hacer una comparación entre algunas variables, como pueden ser el rol y el
sexo de la persona involucrada en el accidente, ¿Hay mayor cantidad de hombres que, siendo
conductores, están involucrados en accidentes que mujeres?

## Conjunto de datos

Este análisis se va a basar en datos referentes a personas involucradas en accidentes de tránsito en nuestro país, entre los años 2013 a 2021, extraídos del portal geográfico de la UNASEV (https://aplicacionesunasev.presidencia.gub.uy/mapas/). Debido a la restricción de 50.000 observaciones por planilla descargada es que se generan planillas individuales, separando Montevideo y los 18 departamentos restantes para cada año de estudio.    
Los datos con los que trabajaremos consisten de 496957 observaciones y 18 variables, entre las cuáles tenemos discretas, continuas y categóricas.



```{r data, echo = FALSE}
library(gapminder)
library(tidyverse)
library(here)
library(lubridate)
library(rgdal)
library(xtable)
library(viridis)

```

```{r, eval=FALSE}
personas_mdeo_2013 <- read_csv(here("Datos/personas_mdeo_2013.txt"))
personas_dptos_2013 <- read_csv(here("Datos/personas_dptos_2013.txt"))
personas_2013 <- rbind(personas_mdeo_2013, personas_dptos_2013)
```

```{r, eval=FALSE}
personas_mdeo_2014 <- read_csv(here("Datos/personas_mdeo_2014.txt"))
personas_dptos_2014 <- read_csv(here("Datos/personas_dptos_2014.txt"))
personas_2014 <- rbind(personas_mdeo_2014, personas_dptos_2014)
```


```{r, eval=FALSE}
personas_mdeo_2015 <- read_csv(here("Datos/personas_mdeo_2015.txt"))
personas_dptos_2015 <- read_csv(here("Datos/personas_dptos_2015.txt"))
personas_2015 <- rbind(personas_mdeo_2015, personas_dptos_2015)
```

```{r, eval=FALSE}
personas_mdeo_2016 <- read_csv(here("Datos/personas_mdeo_2016.txt"))
personas_dptos_2016 <- read_csv(here("Datos/personas_dptos_2016.txt"))
personas_2016 <- rbind(personas_mdeo_2016, personas_dptos_2016)
```

```{r, eval=FALSE}
personas_mdeo_2017 <- read_csv(here("Datos/personas_mdeo_2017.txt"))
personas_dptos_2017 <- read_csv(here("Datos/personas_dptos_2017.txt"))
personas_2017 <- rbind(personas_mdeo_2017, personas_dptos_2017)
```

```{r, eval=FALSE}
personas_mdeo_2018 <- read_csv(here("Datos/personas_mdeo_2018.txt"))
personas_dptos_2018 <- read_csv(here("Datos/personas_dptos_2018.txt"))
personas_2018 <- rbind(personas_mdeo_2018, personas_dptos_2018)
```

```{r, eval=FALSE}
personas_mdeo_2019 <- read_csv(here("Datos/personas_mdeo_2019.txt"))
personas_dptos_2019 <- read_csv(here("Datos/personas_dptos_2019.txt"))
personas_2019 <- rbind(personas_mdeo_2019, personas_dptos_2019)
```

```{r, eval=FALSE}
personas_mdeo_2020 <- read_csv(here("Datos/personas_mdeo_2020.txt"))
personas_dptos_2020 <- read_csv(here("Datos/personas_dptos_2020.txt"))
personas_2020 <- rbind(personas_mdeo_2020, personas_dptos_2020)
```

```{r, eval=FALSE}
personas_2021 <- read_csv(here("Datos/personas_2021.txt"))
```

```{r, eval=FALSE}
#datos de personas involucradas en accidentes de tránsito entre 01/01/2013 y 31/03/2021
personas_13_21 <- rbind(personas_2013, personas_2014,
                        personas_2015, personas_2016,
                        personas_2017, personas_2018,
                        personas_2019, personas_2020,
                        personas_2021)
```

```{r, eval=FALSE}
#Guardamos las planillas unidas como .RData y como .csv, de forma de facilitar la carga de datos y para usar en la aplicación.
save(personas_13_21, file = "personas_13_21.RData")
```

```{r, eval=FALSE}
#write.csv(personas_13_21, file = "personas_13_21.csv")
#Este archivo ocupa 100MB
```

```{r}
load(here("Datos/personas_13_21.RData"))
```


\newpage

## ¿La cantidad de accidentes de tránsito aumenta en algún período específico a lo largo de los años?
 
```{r temporal, echo = FALSE, fig.cap= "Lo que podemos observar en grafico es que la cantidad de accidentes ha tenido una leve disminucion entre el 2013 y el 2016. A partir de ese año, los accidentes se mantienen un rango similar hasta el 2020. Eventualmente la cantidad de accidentes bajo notoriamente en el 2020, precisamente en Marzo debido a la pandemia, pero sobre fin de año la cantidad volvio a la tendencia que se manifiesta en los años anteriores." }

f <- personas_13_21 %>% 
  mutate(Fecha = dmy(Fecha)) %>% 
  mutate(Año = year(Fecha)) %>% 
  mutate(Mes = month(Fecha)) %>% 
  group_by(Año, Mes) %>% 
  summarise(cantidad = n())

ggplot(data = f, aes(x = Mes, y = cantidad, 
                     colour = as.factor(Año))) +
  geom_line(size = 1) +
  geom_point(size = 1.5) +
  facet_wrap(~Año) +
  scale_color_brewer(palette = "Dark2", guide = "none") +
  scale_x_discrete(limit = c(1:12),
                   labels = c("Enero", "Febrero", "Marzo", "Abril",
                              "Mayo", "Junio", "Julio", "Agosto",
                              "Setiembre", "Octubre", "Noviembre",
                              "Diciembre")) +
  theme(axis.text.x = element_text(angle = 90),
        text = element_text(size = 10)) +
  labs(x = "Mes", y = "Cantidad", 
       title = "Evolución temporal de la cantidad de accidentes")

```

\newpage

Nuevos datos para ver si el descenso en la movilidad debido a la pandemia disminuyó el número de fallecidos por accidentes de tránsito.


```{r}
#Nos quedamos con aquellas observaciones que tienen como Tipo de resultado a FALLECIDO EN CENTRO DE ASISTENCIA o FALLECIDO EN EL LUGAR
#fallecidos_2020 <-  personas_2020[grepl("FALLECIDO+", personas_2020$`Tipo de resultado`), ]
```

```{r}
#f_2020 <- fallecidos_2020 %>% 
#  mutate(Fecha = dmy(Fecha)) %>% 
#  mutate(Ano = year(Fecha)) %>% 
#  mutate(Mes = month(Fecha)) %>% 
#  group_by(Ano, Mes) %>% 
#  summarise(cantidad = n())

#f_total <- rbind(f, f_2020) 

#f_total$mes_año <- my(paste(f_total$Mes, f_total$Ano, sep = "-"))
```


```{r}
#Nos quedamos con aquellas observaciones que tienen como Tipo de resultado a FALLECIDO EN CENTRO DE ASISTENCIA o FALLECIDO EN EL LUGAR
#fallecidos_20_21 <-  personas_20_21[grepl("FALLECIDO+", personas_20_21$`Tipo de resultado`), ]
```

```{r}
f$mes_año <- my(paste(f$Mes, f$Año, sep = "-"))
```


```{r,fig.cap="Podemos apreciar que alrededor de marzo de 2020, momento en el cual empezó la pandemia, la cantidad de accidentes de tránsito tiene un gran descenso, debido probablemente a la disminución de movilidad antes mencionada."}
ggplot(data = f, aes(x = mes_año, y = cantidad)) +
  geom_line(size = 1, color = "blue") +
  geom_point(size = 1.5) + 
  geom_smooth(method = 'lm', se = FALSE, color = "red") + 
  scale_color_brewer(palette = "Dark2", guide = "none") +
  theme(axis.text.x = element_text(angle = 90),
        text = element_text(size = 10)) +
  labs(x = "Fecha", y = "Cantidad", 
       title = "Evolución temporal de la cantidad de fallecidos en accidentes de tránsito. Uruguay 2013-2021") +
  theme_bw()
```





\newpage

## En los años 2013 a 2019, ¿cuáles fueron los departamentos que han sufrido mayores accidentes de tránsito, y cuáles fueron los que han sufrido menos?


Los datos referidos a la cantidad de habitantes por departamento fueron extraídos de https://otu.opp.gub.uy a partir del Censo de 2011 realizado por el Instituto Nacional de Estadística.

```{r mapa, echo = FALSE,message=FALSE, results="asis", fig.cap= "Los departamentos con más accidentes son Montevideo y Canelones, con 915 y 686 accidentes respectivamente. Entre los dos departamentos, se acumula el 46 por ciento de accidentes del país. Análogamente, los departamentos con menos accidentes son Treinta y Tres con 44 accidentes, y Flores que acumula un total de 37." }

mapaine <- readOGR(here("ine_depto.shp"),verbose = FALSE)

dframe_depto <- ggplot2::fortify(mapaine)

deptos <- dframe_depto %>%
rename(Departamento = id) %>%
mutate(Departamento=recode(Departamento, `0` = "MONTEVIDEO",
`8` = "RIO NEGRO", `9` = "RIVERA",`7`="PAYSANDU",
`1`="ARTIGAS",`2`="CANELONES",`19`="CERRO LARGO",
`3`="COLONIA",`4`="DURAZNO",`5`="FLORIDA",`6`="LAVALLEJA",
`10`="ROCHA",`11`="SALTO", `12`="SAN JOSE",`13`="SORIANO",
`14`="TREINTA Y TRES", `16`="TACUAREMBO",`17`="FLORES",
`18`="MALDONADO",`15`="ARTIGAS")) 


poblacion<-c(73377,520173,84698,123203,57084,25050,67047,
           58815,164298,1318755,113107,54765,103473,68088,
           124861,108304,82594,90051,48134)
           
cantsiniestros <- personas_13_21 %>%
group_by(Departamento) %>%
summarise(Cantidad = n()) 

habitantes <- cbind(cantsiniestros,poblacion)

tabla<- habitantes %>%
  group_by(Departamento) %>%
summarise(canthabitantes = (Cantidad/poblacion)*1000)

mapauru <- left_join(deptos, tabla, by = "Departamento")

mapauru %>%
ggplot(aes(x = long, y = lat, group = group)) +
geom_polygon(aes(fill = canthabitantes)) +
  scale_fill_viridis_c() +
  labs(x="Longitud", y="Latitud",fill="Cantidad de accidentes",
       title="Cantidad de accidentes por departamento cada 1000
       habitantes")

```

\newpage

## ¿Existe una correlación entre el rol que cumplía la persona fallecida y el sexo de la misma? 

```{r, echo=FALSE, fig.cap= "La conclusión del gráfico es que la mayor cantidad de accidentes ocurren por causa del conductor. Dentro de este rol, notamos la amplia diferencia entre la cantidad de conductores hombres contra la cantidad de accidentes de conductoras mujeres. El hombre genera, aproximadamente, 8 veces más accidentes que lo que generan las mujeres. Con respecto a los otros roles, vemos que en el rubro pasajero es mayor la presencia de la mujer mientras que en el rubro peatón, el hombre supera a la mujer."}

#Hay una observación que en rol dice 'Fallecidos'
personas_13_21 %>%
  filter(!is.na(Sexo) & Rol != "Fallecidos") %>%
  group_by(`Rol`,Sexo) %>%
  summarise(cant =n()) %>%
  ggplot(aes(x = `Rol`, y = cant, fill = Sexo)) +
    geom_bar(stat="identity", position = "dodge") +
    scale_fill_brewer(palette = "Set1") +
    labs(y = "Cantidad", 
         title = "Cantidad de accidentes según el rol de la persona",
         subtitle = "Diferenciado por sexo")

```

## Total de accidentados



```{r}
personas_13_21 <- personas_13_21 %>% 
  mutate(Fecha = dmy(Fecha)) %>% 
  mutate(Año = year(Fecha)) %>% 
  mutate(Mes = month(Fecha)) %>% 
  mutate(mes_año = my(paste(Mes, Año, sep = "-" )))
```


```{r}

#ESta gráfica es con todos los datos y queda un poco más clara la tendencia descendente que en el acumulado por mes

 ggplot(data = personas_13_21, aes(x = mes_año)) +
   geom_line(stat = "count", size = 1, color = "blue") +
   stat_count(geom = "line", size = 1, color = "blue") + 
   theme(axis.text.x = element_text(angle = 90),
         text = element_text(size = 10)) +
   labs(x = "Fecha", y = "Cantidad", 
       title = "Evolución temporal de la cantidad de personas involucradas en accidentes de tránsito. Uruguay 2013-2021") +
   theme_bw()
```


```{r,fig.cap= "La conclusion del grafico es que los autos y las motos son los vehiculos que generan mayor cantidad de accidentes. Era una conclusion logica ya que son los vehiculos mas utilizados, pero lo que expone el grafico es la gran diferencia que hay contra los otros medios de transporte. Corresponde mencionar la disminucion que se genera en 2020 debido a la pandemia. "}
ggplot(data = personas_13_21, aes(x = mes_año,
                                  color = `Tipo de Vehiculo`)) +
  geom_line(stat = "count", size = 1)+
  #stat_count(geom = "line", size = 1) +
  scale_color_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 90),
        text = element_text(size = 10)) +
  labs(x = "Fecha", y = "Cantidad", 
       title = "Evolución temporal de la cantidad de accidentes de tránsito por tipo de vehículo. Uruguay 2013-2021") +
  theme_bw()
```


```{r}
personas_13_21 %>%
  mutate(Resultado = if_else(grepl("FALLECIDO+", `Tipo de resultado`), "FALLECIDO", `Tipo de resultado`)) %>% 
  filter(`Tipo de Vehiculo` != "MONOPATIN ELECTRICO") %>% 
  ggplot(aes(Resultado, 
                           fill = `Tipo de Vehiculo`)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_viridis(discrete = T, option = "A") +
  ylab("Porcentaje") +
  theme_bw()
```

